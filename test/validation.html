<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AV-Plan Validation Tests</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #0066cc;
            padding-bottom: 10px;
        }

        #tests {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-item {
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ccc;
            background-color: #fafafa;
            border-radius: 4px;
        }

        .test-item.pass {
            border-left-color: #28a745;
            background-color: #f0f8f0;
        }

        .test-item.fail {
            border-left-color: #dc3545;
            background-color: #fff0f0;
        }

        .test-item.warning {
            border-left-color: #ffc107;
            background-color: #fffcf0;
        }

        .test-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .test-result {
            font-size: 14px;
            color: #666;
        }

        .test-time {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }

        button:hover {
            background-color: #0052a3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .summary {
            padding: 15px;
            background-color: #e3f2fd;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .summary strong {
            font-size: 16px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>üß™ AV-Plan Validation Tests</h1>

    <div class="summary" id="summary">
        <strong>Test Suite</strong><br>
        Validerer alle hovedfunksjoner og API-tilkoblinger
    </div>

    <div id="tests">
        <div class="spinner"></div>
        <p style="text-align: center;">Kj√∏rer tester...</p>
    </div>

    <button id="runAllTests">Kj√∏r alle tester p√• nytt</button>
    <button id="exportResults">Eksporter resultater</button>

    <script>
        const testResults = [];
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;
        let warningTests = 0;

        async function runTest(name, testFn) {
            const startTime = Date.now();
            let result = { name, status: 'fail', message: '', time: 0 };

            try {
                const testResult = await testFn();
                result.status = testResult.status || 'pass';
                result.message = testResult.message || 'OK';
            } catch (error) {
                result.status = 'fail';
                result.message = error.message || 'Unknown error';
            }

            result.time = Date.now() - startTime;
            testResults.push(result);

            totalTests++;
            if (result.status === 'pass') passedTests++;
            else if (result.status === 'fail') failedTests++;
            else if (result.status === 'warning') warningTests++;

            displayTestResult(result);
            return result;
        }

        function displayTestResult(result) {
            const testsDiv = document.getElementById('tests');

            const testItem = document.createElement('div');
            testItem.className = `test-item ${result.status}`;

            const icon = result.status === 'pass' ? '‚úÖ' :
                        result.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå';

            testItem.innerHTML = `
                <div class="test-name">${icon} ${result.name}</div>
                <div class="test-result">${result.message}</div>
                <div class="test-time">Tid: ${result.time}ms</div>
            `;

            testsDiv.appendChild(testItem);
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <strong>Test Resultater</strong><br>
                Total: ${totalTests} |
                <span style="color: #28a745;">Best√•tt: ${passedTests}</span> |
                <span style="color: #dc3545;">Feilet: ${failedTests}</span> |
                <span style="color: #ffc107;">Advarsler: ${warningTests}</span>
            `;
        }

        // Test Functions

        async function testNVDBAPIConnectivity() {
            // Create a small bounding box around Trondheim
            const kartutsnitt = 'POLYGON((10.39 63.43, 10.40 63.43, 10.40 63.44, 10.39 63.44, 10.39 63.43))';

            const url = `https://nvdbapiles.atlas.vegvesen.no/vegnett/veglenkesekvenser/segmentert?kartutsnitt=${encodeURIComponent(kartutsnitt)}&srid=wgs84`;

            const response = await fetch(url, {
                headers: {
                    'X-Client': 'avplan-test',
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (!data || !data.objekter || data.objekter.length === 0) {
                return { status: 'warning', message: 'API respons, men ingen veier funnet' };
            }

            return {
                status: 'pass',
                message: `NVDB API V4 tilgjengelig - Funnet ${data.objekter.length} veier`
            };
        }

        async function testGeonorgeAPI() {
            const response = await fetch('https://ws.geonorge.no/adresser/v1/sok?fuzzy=true&sok=Trondheim');

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (!data.adresser || data.adresser.length === 0) {
                throw new Error('Ingen adresser funnet');
            }

            return {
                status: 'pass',
                message: `Geonorge API tilgjengelig - Funnet ${data.adresser.length} adresser`
            };
        }

        async function testKartverketTiles() {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout - kunne ikke laste kartflis'));
                }, 5000);

                img.onload = () => {
                    clearTimeout(timeout);
                    resolve({
                        status: 'pass',
                        message: 'Kartverket kartfliser lastet OK'
                    });
                };

                img.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('Kunne ikke laste kartflis'));
                };

                img.src = 'https://cache.kartverket.no/v1/wmts/1.0.0/topo/default/webmercator/5/8/9.png';
            });
        }

        async function testLocalStorage() {
            try {
                const testKey = '__avplan_test__';
                const testValue = 'test123';

                localStorage.setItem(testKey, testValue);
                const retrieved = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);

                if (retrieved !== testValue) {
                    throw new Error('localStorage read/write mismatch');
                }

                // Check quota
                const used = JSON.stringify(localStorage).length;
                const usedKB = (used / 1024).toFixed(1);

                return {
                    status: 'pass',
                    message: `localStorage fungerer - Brukt: ${usedKB} KB`
                };
            } catch (error) {
                throw new Error(`localStorage error: ${error.message}`);
            }
        }

        async function testTurfJS() {
            if (typeof turf === 'undefined') {
                throw new Error('Turf.js ikke lastet');
            }

            const point1 = turf.point([10.3951, 63.4305]);
            const point2 = turf.point([10.4051, 63.4405]);
            const distance = turf.distance(point1, point2, { units: 'meters' });

            if (typeof distance !== 'number' || distance <= 0) {
                throw new Error('Turf.js distance calculation failed');
            }

            return {
                status: 'pass',
                message: `Turf.js fungerer - Test distance: ${distance.toFixed(0)}m`
            };
        }

        async function testHTML2Canvas() {
            if (typeof html2canvas === 'undefined') {
                throw new Error('html2canvas ikke lastet');
            }

            // Create test element
            const testDiv = document.createElement('div');
            testDiv.style.width = '100px';
            testDiv.style.height = '100px';
            testDiv.style.backgroundColor = '#0066cc';
            document.body.appendChild(testDiv);

            try {
                const canvas = await html2canvas(testDiv, { logging: false });

                if (!canvas || canvas.width === 0) {
                    throw new Error('Canvas not created');
                }

                return {
                    status: 'pass',
                    message: 'html2canvas fungerer OK'
                };
            } finally {
                document.body.removeChild(testDiv);
            }
        }

        async function testBrowserCompatibility() {
            const tests = [];

            // ES6 support
            try {
                eval('const test = () => true');
                tests.push('ES6');
            } catch (e) {
                throw new Error('ES6 ikke st√∏ttet');
            }

            // Fetch API
            if (typeof fetch === 'function') {
                tests.push('Fetch API');
            } else {
                throw new Error('Fetch API ikke st√∏ttet');
            }

            // localStorage
            if (typeof localStorage !== 'undefined') {
                tests.push('localStorage');
            } else {
                throw new Error('localStorage ikke st√∏ttet');
            }

            // Canvas
            const canvas = document.createElement('canvas');
            if (canvas.getContext && canvas.getContext('2d')) {
                tests.push('Canvas');
            } else {
                throw new Error('Canvas ikke st√∏ttet');
            }

            return {
                status: 'pass',
                message: `Nettleser st√∏tter: ${tests.join(', ')}`
            };
        }

        async function testResponsiveness() {
            const width = window.innerWidth;
            const height = window.innerHeight;

            let deviceType = 'Desktop';
            if (width < 768) deviceType = 'Mobile';
            else if (width < 1024) deviceType = 'Tablet';

            const touchSupport = 'ontouchstart' in window ? 'Ja' : 'Nei';

            return {
                status: 'pass',
                message: `${deviceType} (${width}x${height}) - Touch: ${touchSupport}`
            };
        }

        async function testCORSHeaders() {
            try {
                const response = await fetch('https://nvdbapiles.atlas.vegvesen.no/vegnett/api/v4/status');
                const corsHeader = response.headers.get('Access-Control-Allow-Origin');

                if (!corsHeader) {
                    return {
                        status: 'warning',
                        message: 'CORS header ikke funnet (kan fungere likevel)'
                    };
                }

                return {
                    status: 'pass',
                    message: `CORS OK - ${corsHeader}`
                };
            } catch (error) {
                return {
                    status: 'warning',
                    message: `CORS test feilet: ${error.message}`
                };
            }
        }

        // Run All Tests
        async function runAllTests() {
            // Reset
            testResults.length = 0;
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            warningTests = 0;

            const testsDiv = document.getElementById('tests');
            testsDiv.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Kj√∏rer tester...</p>';

            // Run tests in sequence
            await runTest('NVDB API V4 Tilkobling', testNVDBAPIConnectivity);
            await runTest('Geonorge API', testGeonorgeAPI);
            await runTest('Kartverket Kartfliser', testKartverketTiles);
            await runTest('localStorage', testLocalStorage);
            await runTest('Turf.js Bibliotek', testTurfJS);
            await runTest('html2canvas Bibliotek', testHTML2Canvas);
            await runTest('Nettleser Kompatibilitet', testBrowserCompatibility);
            await runTest('Responsivitet', testResponsiveness);
            await runTest('CORS Headers', testCORSHeaders);

            updateSummary();
        }

        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                browser: navigator.userAgent,
                results: testResults,
                summary: {
                    total: totalTests,
                    passed: passedTests,
                    failed: failedTests,
                    warnings: warningTests
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `avplan-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        document.getElementById('exportResults').addEventListener('click', exportResults);

        // Auto-run on load
        window.addEventListener('load', () => {
            // Load required libraries first
            const scripts = [
                'https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
            ];

            let loaded = 0;
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loaded++;
                    if (loaded === scripts.length) {
                        setTimeout(runAllTests, 500);
                    }
                };
                document.head.appendChild(script);
            });
        });
    </script>
</body>
</html>
